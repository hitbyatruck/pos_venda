{% extends "base.html" %}
{% load static %}
{% block title %}Criar PAT{% endblock %}
{% block content %}
<div class="container">
  <h2 class="mb-4">Criar Pedido de Assistência Técnica (PAT)</h2>
  <form method="post">
    {% csrf_token %}
    <!-- Linha 1: Cliente e Número da PAT -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.cliente.id_for_label }}">Cliente</label>
        {{ form.cliente }}
      </div>
      <div class="col-md-6 mb-3">
        <label for="{{ form.pat_number.id_for_label }}">Número da PAT</label>
        {{ form.pat_number }}
      </div>
    </div>
    
    <!-- Linha 2: Data de Entrada, Estado e Data de Reparação -->
    <div class="row">
      <div class="col-md-4 mb-3">
        <label for="{{ form.data_entrada.id_for_label }}">Data de Entrada</label>
        {{ form.data_entrada }}
      </div>
      <div class="col-md-4 mb-3">
        <label for="{{ form.estado.id_for_label }}">Estado da PAT</label>
        {{ form.estado }}
      </div>
      <div class="col-md-4 mb-3">
        <label for="{{ form.data_reparacao.id_for_label }}">Data de Reparação</label>
        {{ form.data_reparacao }}
      </div>
    </div>
    
    <!-- Linha 3: Equipamento e Garantia -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.equipamento.id_for_label }}">Equipamento</label>
        {{ form.equipamento }}
      </div>
      <div class="col-md-6 mb-3 d-flex align-items-center">
        <div class="form-check">
          {{ form.garantia }}
          <label class="form-check-label ms-2" for="{{ form.garantia.id_for_label }}">Em Garantia</label>
        </div>
      </div>
    </div>
    
    <!-- (Opcional) Linha 4: Data de Criação -->
    <!-- Se preferir que este campo não apareça no formulário, pode removê-lo do template -->
    <!--
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="{{ form.data_criacao.id_for_label }}">Data de Criação</label>
        {{ form.data_criacao }}
      </div>
    </div>
    -->
    
    <!-- Seção Itens -->
    <h4 class="mt-4">Itens (Serviços e Componentes)</h4>
    {{ formset.management_form }}
    <table class="table table-bordered" id="itensTable">
      <thead>
        <tr>
          <th style="width: 15%;">Tipo</th>
          <th style="width: 15%;">Referência</th>
          <th style="width: 50%;">Designação</th>
          <th style="width: 10%;">Preço (€)</th>
          <th style="width: 10%;">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for form in formset %}
          <tr class="item-row">
            <td>
              {{ form.tipo }}
              {% if form.tipo.errors %}
                <div class="text-danger">{{ form.tipo.errors }}</div>
              {% endif %}
            </td>
            <td>
              {{ form.referencia }}
              {% if form.referencia.errors %}
                <div class="text-danger">{{ form.referencia.errors }}</div>
              {% endif %}
            </td>
            <td>
              {{ form.designacao }}
              {% if form.designacao.errors %}
                <div class="text-danger">{{ form.designacao.errors }}</div>
              {% endif %}
            </td>
            <td>
              <div class="input-group">
                <span class="input-group-text">€</span>
                {{ form.preco }}
              </div>
              {% if form.preco.errors %}
                <div class="text-danger">{{ form.preco.errors }}</div>
              {% endif %}
            </td>
            <td class="text-center">
              <!-- Botão para excluir o item -->
              <button type="button" class="btn btn-danger btn-sm item-delete" data-index="{{ forloop.counter0 }}">
                Excluir
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="button" id="addItemBtn" class="btn btn-outline-primary mb-4">Adicionar Item</button>
    
    <!-- Campo para Relatório -->
    <div class="mb-4">
      <label for="{{ form.relatorio.id_for_label }}">Relatório</label>
      {{ form.relatorio }}
    </div>
    
    <!-- Botões para Salvar e Voltar -->
    <div class="mb-4">
      <button type="submit" class="btn btn-primary">Salvar PAT</button>
      <a href="{% url 'listar_pats' %}" class="btn btn-secondary">Voltar</a>
    </div>
  </form>
</div>

<!-- Modal de Confirmação para Exclusão de Item -->
<div class="modal fade" id="itemDeleteModal" tabindex="-1" aria-labelledby="itemDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemDeleteModalLabel">Confirmar Exclusão do Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este item?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="itemDeleteConfirmBtn" class="btn btn-danger">Excluir</button>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Configura o dropdown de Cliente
    var clienteSelect = document.getElementById("id_cliente");
    if (clienteSelect) {
        // Insere a opção "Adicionar Novo Cliente" se não existir
        if (clienteSelect.options.length === 0 || clienteSelect.options[0].value !== "adicionar") {
            var opt = document.createElement("option");
            opt.value = "adicionar";
            opt.text = "Adicionar Novo Cliente";
            clienteSelect.insertBefore(opt, clienteSelect.firstChild);
        }
        clienteSelect.addEventListener("change", function() {
            console.log("Cliente selecionado:", this.value);
            if (this.value === "adicionar") {
                window.location.href = "{% url 'adicionar_cliente' %}";
                return;
            }
            updateEquipamentoDropdown(this.value);
        });
    }
    
    // Função para atualizar o dropdown de Equipamento com base no cliente selecionado
    function updateEquipamentoDropdown(clienteId) {
        var equipamentoSelect = document.getElementById("id_equipamento");
        if (!equipamentoSelect) return;
        // Se o clienteId for inválido ou vazio, limpa o dropdown e mostra o aviso
        if (!clienteId || clienteId.trim() === "" || clienteId === "adicionar") {
            equipamentoSelect.innerHTML = "";
            var opt = document.createElement("option");
            opt.value = "";
            opt.text = "Selecione um Cliente Primeiro";
            equipamentoSelect.appendChild(opt);
            return;
        }
        // Faz a requisição AJAX para obter os equipamentos associados ao cliente
        fetch("{% url 'equipamentos_por_cliente' %}?cliente_id=" + clienteId)
            .then(response => response.json())
            .then(data => {
                equipamentoSelect.innerHTML = "";
                // Adiciona a primeira opção: "Adicionar Equipamento Ao Cliente"
                var addOption = document.createElement("option");
                addOption.value = "adicionar";
                addOption.text = "Adicionar Equipamento Ao Cliente";
                equipamentoSelect.appendChild(addOption);
                // Se houver equipamentos, adiciona-os como opções
                if (data.equipamentos && data.equipamentos.length > 0) {
                    data.equipamentos.forEach(function(eq) {
                        var option = document.createElement("option");
                        option.value = eq.id;
                        option.text = eq.nome + (eq.numero_serie ? " (" + eq.numero_serie + ")" : "");
                        equipamentoSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error("Erro ao obter equipamentos:", error);
            });
    }
    
    // Configura o dropdown de Equipamento para redirecionar se a opção "adicionar" for selecionada
    var equipamentoSelect = document.getElementById("id_equipamento");
    if (equipamentoSelect) {
        equipamentoSelect.addEventListener("change", function() {
            if (this.value === "adicionar") {
                if (!clienteSelect.value || clienteSelect.value === "adicionar" || clienteSelect.value.trim() === "") {
                    alert("Selecione um Cliente Primeiro.");
                    this.selectedIndex = 0;
                } else {
                    window.location.href = "/clientes/detalhes/" + clienteSelect.value + "/#equipamentos";
                }
            }
        });
    }
});
</script>
{% endblock %}

{% endblock %}
